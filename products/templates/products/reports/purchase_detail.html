{% load tailwind_tags %}
{% load humanize %}
<!doctype html>
<html lang="th" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏¥‡∏• {{ purchase.doc_no }}</title>
  {% tailwind_css %}
</head>
<body class="bg-base-200">
<div class="flex min-h-screen">

  {# ========== Sidebar (‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå) ========== #}
  <div class="no-print">
    {% include "partials/sidebar.html" %}
  </div>

  {# ========== Main Content ========== #}
  <main class="flex-1 p-8 overflow-y-auto">
    <div class="max-w-[1400px] mx-auto">
      
      {# ========== Header ========== #}
      <div class="mb-6 no-print">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</h1>
            <p class="text-gray-600">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: <span class="font-mono font-bold">{{ purchase.doc_no }}</span></p>
          </div>
          <div class="flex gap-2">
            {# ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö #}
            <a href="{% url 'purchase_report' %}" class="btn btn-ghost gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
              ‡∏Å‡∏•‡∏±‡∏ö
            </a>
            {# ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ DRAFT) #}
            {% if purchase.status == 'DRAFT' %}
            <form method="post" action="{% url 'cancel_purchase' purchase.id %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-error gap-2" 
                      onclick="return confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ {{ purchase.doc_no }} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
              </button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>

      {# Messages #}
      <div class="no-print mb-6">
        {% if messages %}
          {% for m in messages %}
            <div class="alert {% if m.tags == 'success' %}alert-success{% elif m.tags == 'error' %}alert-error{% elif m.tags == 'warning' %}alert-warning{% else %}alert-info{% endif %} shadow-lg mb-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                {% if m.tags == 'success' %}
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                {% else %}
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                {% endif %}
              </svg>
              <span>{{ m }}</span>
            </div>
          {% endfor %}
        {% endif %}
      </div>

      {# ========== ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏ö‡∏¥‡∏• ========== #}
      <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
          <div class="grid md:grid-cols-2 gap-6">
            {# ‡∏ã‡πâ‡∏≤‡∏¢ #}
            <div>
              <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
              </h2>
              
              <div class="space-y-3">
                <div class="flex">
                  <span class="font-semibold w-32">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</span>
                  <span class="font-mono font-bold text-primary">{{ purchase.doc_no }}</span>
                </div>
                
                <div class="flex">
                  <span class="font-semibold w-32">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
                  <span>{{ purchase.purchase_date|date:"d/m/Y H:i" }} ‡∏ô.</span>
                </div>
                
                <div class="flex">
                  <span class="font-semibold w-32">‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå:</span>
                  <span class="badge badge-primary badge-lg">{{ purchase.supplier.name }}</span>
                </div>
                
                <div class="flex">
                  <span class="font-semibold w-32">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                  <span>
                    {% if purchase.status == 'DRAFT' %}
                      <span class="badge badge-ghost badge-lg">üìù Draft</span>
                    {% elif purchase.status == 'POSTED' %}
                      <span class="badge badge-success badge-lg">‚úÖ Posted</span>
                    {% elif purchase.status == 'CANCELLED' %}
                      <span class="badge badge-error badge-lg">‚ùå Cancelled</span>
                    {% endif %}
                  </span>
                </div>
              </div>
            </div>

            {# ‡∏Ç‡∏ß‡∏≤ #}
            <div>
              <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
              </h2>
              
              <div class="space-y-3">
                <div class="flex">
                  <span class="font-semibold w-32">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</span>
                  <span class="badge badge-outline">{{ purchase.created_by.username }}</span>
                </div>
                
                <div class="flex">
                  <span class="font-semibold w-32">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</span>
                  <span>{{ purchase.created_at|date:"d/m/Y H:i" }} ‡∏ô.</span>
                </div>
                
                {% if purchase.remark %}
                <div class="flex">
                  
                  <span class="text-sm text-gray-600">{{ purchase.remark }}</span>
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          {# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå #}
          {% if purchase.supplier.phone or purchase.supplier.address %}
          <div class="divider"></div>
          <div>
            <h3 class="font-bold mb-2">üìû ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå</h3>
            <div class="grid md:grid-cols-3 gap-4 text-sm">
              {% if purchase.supplier.phone %}
              <div>
                <span class="font-semibold">‡πÇ‡∏ó‡∏£:</span> {{ purchase.supplier.phone }}
              </div>
              {% endif %}
              {% if purchase.supplier.address %}
              <div class="md:col-span-3">
                <span class="font-semibold">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</span> {{ purchase.supplier.address }}
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      {# ========== ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ========== #}
      <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
          <h2 class="card-title text-xl mb-4">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
          
          <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
              <thead class="bg-gradient-to-r from-green-600 to-blue-600 text-white">
                <tr>
                  <th class="text-center">#</th>
                  <th>‡∏£‡∏´‡∏±‡∏™</th>
                  <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                  <th>‡∏´‡∏°‡∏ß‡∏î</th>
                  <th class="w-1/4">üöó ‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</th>
                  <th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                  <th class="text-right">‡∏£‡∏ß‡∏°</th>
                </tr>
              </thead>
              <tbody>
                {% for item in items %}
                <tr>
                  <td class="text-center font-bold">{{ forloop.counter }}</td>
                  <td>
                    <span class="badge badge-neutral font-mono font-bold whitespace-nowrap">{{ item.product.sku }}</span>
                  </td>
                  <td>
                    <div class="font-bold">{{ item.product.name }}</div>
                    <div class="text-xs text-gray-500 mt-1">{{ item.product.unit }}</div>
                  </td>
                  <td>
                    <span class="badge badge-primary badge-sm whitespace-nowrap">{{ item.product.category.name }}</span>
                  </td>
                  <td>
                    <div class="text-sm">
                      {% if item.product.compatible_models %}
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-2">
                          <div class="flex items-start gap-1">
                            <span class="text-orange-600 text-xs">üöó</span>
                            <div class="text-orange-800 leading-relaxed">
                              {{ item.product.compatible_models }}
                            </div>
                          </div>
                        </div>
                      {% else %}
                        <span class="text-gray-400">-</span>
                      {% endif %}
                    </div>
                  </td>
                  <td class="text-right">
                    <div class="font-semibold">{{ item.quantity|floatformat:0 }} {{ item.product.unit }}</div>
                    {% if item.product.pieces_per_unit != 1 %}
                      <div class="text-xs text-gray-500">
                        ({{ item.actual_stock|floatformat:0 }} ‡∏ä‡∏¥‡πâ‡∏ô)
                      </div>
                    {% endif %}
                  </td>
                  <td class="text-right">{{ item.unit_cost|floatformat:2 }}</td>
                  <td class="text-right">
                    <span class="font-bold text-green-600">{{ item.line_total|default:0|floatformat:2|intcomma }}</span>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="8" class="text-center py-4 text-gray-500">
                    ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot class="bg-gray-100">
                <tr class="font-bold">
                  <td colspan="7" class="text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</td>
                  <td class="text-right">
                    <span class="text-xl text-green-600">{{ total_amount|default:0|floatformat:2|intcomma }}</span>
                  </td>
                </tr>
                <tr>
                  <td colspan="8" class="text-right text-gray-500 text-sm">‡∏ö‡∏≤‡∏ó</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      {# ========== ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ï‡πá‡∏≠‡∏Å ========== #}
      <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
          <h2 class="card-title text-xl mb-4">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏ï‡πá‡∏≠‡∏Å</h2>
          
          <div class="overflow-x-auto">
            <table class="table table-sm">
              <thead class="bg-blue-100">
                <tr>
                  <th>‡∏£‡∏´‡∏±‡∏™</th>
                  <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                  <th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th>
                  <th class="text-right">‡∏ä‡∏¥‡πâ‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                  <th class="text-right">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡∏ä‡∏¥‡πâ‡∏ô)</th>
                </tr>
              </thead>
              <tbody>
                {% for item in items %}
                <tr>
                  <td class="font-mono text-xs badge badge-ghost">{{ item.product.sku }}</td>
                  <td>{{ item.product.name }}</td>
                  <td class="text-right">{{ item.quantity|floatformat:0 }} {{ item.product.unit }}</td>
                  <td class="text-right">{{ item.product.pieces_per_unit|floatformat:0 }} ‡∏ä‡∏¥‡πâ‡∏ô/{{ item.product.purchase_unit_name|default:item.product.unit }}</td>
                  <td class="text-right">
                    <span class="badge badge-success font-bold">
                      +{{ item.actual_stock|floatformat:0 }} ‡∏ä‡∏¥‡πâ‡∏ô
                    </span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if purchase.status == 'POSTED' %}
          <div class="alert alert-success mt-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span>
          </div>
          {% elif purchase.status == 'DRAFT' %}
          <div class="alert alert-warning mt-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á (DRAFT) ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å</span>
          </div>
          {% elif purchase.status == 'CANCELLED' %}
          <div class="alert alert-error mt-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
          </div>
          {% endif %}
        </div>
      </div>

      {# ========== Print Version (‡∏ã‡πà‡∏≠‡∏ô‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå) ========== #}
      <div class="print-only">
        <div class="text-center mb-4">
          <h1 class="text-2xl font-bold">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
          <p class="text-lg">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: {{ purchase.doc_no }}</p>
        </div>
        <div class="text-sm text-right mb-2">
          ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: {% now "d/m/Y H:i" %} ‡∏ô.
        </div>
      </div>

    </div>
  </main>
</div>
</body>
</html>