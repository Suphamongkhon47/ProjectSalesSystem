<!-- Modal ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô - QR Code -->
<dialog id="payment-qr-modal" class="modal">
  <div class="modal-box max-w-2xl">
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold">üí∞ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (QR Code)</h3>
      <button class="btn btn-sm btn-circle btn-ghost" onclick="closeQRModal()">‚úï</button>
    </div>
    
    <!-- Content -->
    <div class="space-y-6">
      
      <!-- ‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞ -->
      <div class="text-center bg-primary/10 p-4 rounded-lg">
        <p class="text-gray-600 text-sm">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
        <p class="text-5xl font-bold text-primary" id="modal-qr-total">0.00 ‡∏ø</p>
      </div>
      
      <!-- QR Code -->
      <div class="flex justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl">
          <div id="qr-code-container" class="flex items-center justify-center w-64 h-64 bg-gray-100 rounded">
            <div class="text-center">
              <div class="loading loading-spinner loading-lg"></div>
              <p class="text-gray-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code...</p>
            </div>
          </div>
          <p class="text-center text-sm text-gray-600 mt-4">
            ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•: <span id="modal-qr-doc-no" class="font-mono font-bold">-</span>
          </p>
        </div>
      </div>
      
      <!-- ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ -->
      <div class="alert alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
          <h3 class="font-bold">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
          <div class="text-sm">
            1. ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>
            2. ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô<br>
            3. <strong>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</strong> (‡πÄ‡∏ä‡πà‡∏ô 500 ‡∏ö‡∏≤‡∏ó)<br>
            4. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô<br>
            5. ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
          </div>
        </div>
      </div>
      
      <!-- Checkbox ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
      <div class="form-control">
        <label class="label cursor-pointer justify-start gap-4">
          <input type="checkbox" id="modal-qr-confirm" class="checkbox checkbox-lg checkbox-success" />
          <span class="label-text text-lg">‚úÖ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß)</span>
        </label>
      </div>
      
    </div>
    
    <!-- Footer -->
    <div class="modal-action">
      <button class="btn btn-lg btn-outline" onclick="closeQRModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-success btn-lg" onclick="confirmQRPayment()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
      </button>
    </div>
    
  </div>
  
  <form method="dialog" class="modal-backdrop">
    <button>‡∏õ‡∏¥‡∏î</button>
  </form>
</dialog>

<script>
// ===================================
// Modal QR Code - Functions
// ===================================

async function openQRModal() {
  const grandTotal = parseFloat(document.getElementById('grand-total').textContent.replace(' ‡∏ø', '')) || 0;
  const docNo = document.getElementById('doc-no').textContent;
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
  document.getElementById('modal-qr-total').textContent = grandTotal.toFixed(2) + ' ‡∏ø';
  document.getElementById('modal-qr-doc-no').textContent = docNo;
  document.getElementById('modal-qr-confirm').checked = false;
  
  // ‡πÄ‡∏õ‡∏¥‡∏î Modal
  document.getElementById('payment-qr-modal').showModal();
  
  // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API)
  await generateQRCode(grandTotal, docNo);
}

function closeQRModal() {
  document.getElementById('payment-qr-modal').close();
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏à‡∏£‡∏¥‡∏á
async function generateQRCode(amount, docNo) {
  const container = document.getElementById('qr-code-container');
  
  // ‡πÅ‡∏™‡∏î‡∏á Loading
  container.innerHTML = `
    <div class="text-center">
      <div class="loading loading-spinner loading-lg"></div>
      <p class="text-gray-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code...</p>
    </div>
  `;
  
  try {
    // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏™‡∏£‡πâ‡∏≤‡∏á QR
    const response = await fetch("{% url 'generate_qr_code' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        amount: amount,
        reference: docNo
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á QR Code
      container.innerHTML = `
        <img src="${result.qr_image}" 
             alt="QR Code PromptPay" 
             class="w-64 h-64"
             style="image-rendering: pixelated;">
      `;
      
      console.log('‚úÖ QR Code ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', amount, '‡∏ö‡∏≤‡∏ó');
    } else {
      // ‚ùå ‡πÅ‡∏™‡∏î‡∏á Error
      container.innerHTML = `
        <div class="text-center text-error">
          <div class="text-4xl mb-2">‚ùå</div>
          <p class="text-sm">${result.error}</p>
        </div>
      `;
      
      console.error('‚ùå QR Code Error:', result.error);
    }
    
  } catch (error) {
    // ‚ùå ‡πÅ‡∏™‡∏î‡∏á Error
    console.error('‚ùå QR Code Error:', error);
    container.innerHTML = `
      <div class="text-center text-error">
        <div class="text-4xl mb-2">‚ùå</div>
        <p class="text-sm">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÑ‡∏î‡πâ</p>
        <p class="text-xs text-gray-500 mt-2">${error.message}</p>
      </div>
    `;
  }
}

function confirmQRPayment() {
  const confirmed = document.getElementById('modal-qr-confirm').checked;
  
  if (!confirmed) {
    alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
    return;
  }
  
  const totalText = document.getElementById('modal-qr-total').textContent.replace(' ‡∏ø', '');
  const grandTotal = parseFloat(totalText) || 0;
  
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
  window.paymentData = {
    method: 'qr',
    received: grandTotal,
    change: 0
  };
  
  // ‡∏õ‡∏¥‡∏î Modal
  closeQRModal();
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•
  saveSaleWithPayment();
}
</script>