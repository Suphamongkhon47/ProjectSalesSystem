{% load tailwind_tags %}
<!doctype html>
<html lang="th" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>üõí ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
  {% tailwind_css %}
  <style>
    body { font-family: 'Inter', 'Sarabun', sans-serif; background-color: #f3f4f6; }
    
    /* Animation */
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    .badge-bounce { animation: bounce 1s infinite; }

    /* Clean Table Style (‡∏ò‡∏µ‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô) */
    .table-clean th { 
      background-color: #f9fafb; 
      color: #6b7280; 
      font-weight: 600; 
      text-transform: uppercase; 
      font-size: 0.75rem; 
      border-bottom: 1px solid #e5e7eb; 
    }
    .table-clean td { border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
    
    /* Custom Card */
    .card-clean {
        background-color: white;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        border-radius: 0.5rem;
    }
  </style>
</head>
<body class="text-gray-800 bg-[#f3f4f6] overflow-hidden">

<div class="flex min-h-screen">
  {% include "partials/sidebar.html" %}

  <main class="flex-1 flex flex-col h-screen overflow-hidden">
    
    {# ========== Header (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß Clean) ========== #}
    <div class="bg-gradient-to-r from-blue-600 to-blue-500 border-b border-blue-700 px-6 py-3 shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-bold text-white flex items-center gap-2">
            <span class="text-yellow-300">üõí</span> ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          </h1>
          <p class="text-xs text-blue-100 mt-0.5">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: <span id="doc-no" class="font-mono font-bold text-white bg-blue-700/50 px-2 py-0.5 rounded">{{ doc_no }}</span></p>
        </div>
        <div class="flex items-center gap-3">
          <button onclick="loadHeldBills()" class="btn btn-sm btn-ghost bg-white/20 border border-white/30 hover:bg-white/30 text-white gap-2 relative backdrop-blur-sm">
            <span>üìã ‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ</span>
            <span id="held-count-badge" class="badge badge-error badge-sm absolute -top-2 -right-2 hidden">0</span>
          </button>
          
          <div class="bg-white/20 backdrop-blur-sm border border-white/30 px-4 py-1 rounded-lg text-right">
            <div class="text-[10px] text-blue-100 uppercase">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
            <div class="text-lg font-bold text-white font-mono leading-none" id="clock">00:00:00</div>
          </div>
        </div>
      </div>
    </div>

    {# ========== Body Layout ========== #}
    <div class="flex-1 flex gap-4 p-4 overflow-hidden">
      
      {# --- LEFT: Search & List (70%) --- #}
      <div class="flex-1 flex flex-col gap-4 min-w-0">
        
        {# 1. Car Filter (Clean Card) #}
        <div class="card-clean p-3 flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-orange-50 flex items-center justify-center text-orange-500">üöó</div>
            <input type="text" id="customer-car" class="input input-sm input-ghost w-full focus:bg-transparent" 
                   placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô Vios 2012)..." onchange="updateCarFilter()">
            <button onclick="clearCarFilter()" class="btn btn-xs btn-circle btn-ghost text-gray-400">‚úï</button>
        </div>
        
        {# 2. Search Product (Clean Card) #}
        <div class="card-clean p-4 relative z-20">
            <div class="flex gap-2">
              <div class="relative flex-1">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
                  <input type="text" id="search-input" class="input input-bordered w-full pl-9 font-mono" 
                         placeholder="SKU, ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ..." autofocus>
              </div>
              <button id="search-btn" class="btn btn-primary px-6">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>
            
            {# Dropdown Result #}
            <div id="search-results" class="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-gray-200 p-2 hidden max-h-80 overflow-y-auto z-50">
              <div class="text-xs text-gray-500 mb-2 px-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (<span id="result-count">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
              <div id="result-container" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
            </div>
        </div>

        {# 3. Product List Table (Table Clean) #}
        <div class="card-clean flex-1 overflow-hidden flex flex-col">
          <div class="p-3 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
             <h2 class="font-bold text-gray-700 flex items-center gap-2">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
          </div>
          
          <div class="flex-1 overflow-y-auto">
            <table class="table table-clean table-xs table-pin-rows w-full">
              <thead>
                <tr>
                  <th class="w-10 text-center">#</th>
                  <th>SKU</th>
                  <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                  <th class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                  <th class="text-right">‡∏£‡∏ß‡∏°</th>
                  <th class="w-10"></th>
                </tr>
              </thead>
              <tbody id="cart-items" class="bg-white">
                <tr id="empty-cart">
                  <td colspan="7" class="text-center py-20">
                    <div class="flex flex-col items-center justify-center text-gray-300">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                      <div class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {# --- RIGHT: Summary & Actions (30%) --- #}
      <div class="w-80 flex flex-col gap-4 overflow-y-auto min-w-[320px]">
        
        {# Settings #}
        <div class="card-clean p-4 space-y-3">
           <div>
             <label class="text-xs font-bold text-gray-500 uppercase">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤</label>
             <select id="price-type-select" class="select select-bordered select-sm w-full mt-1 bg-white">
               <option value="retail" selected>üõçÔ∏è ‡∏Ç‡∏≤‡∏¢‡∏õ‡∏•‡∏µ‡∏Å</option>
               <option value="wholesale">üì¶ ‡∏Ç‡∏≤‡∏¢‡∏™‡πà‡∏á</option>
             </select>
           </div>
           <div>
             <label class="text-xs font-bold text-gray-500 uppercase">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</label>
             <select id="payment-method-select" class="select select-bordered select-sm w-full mt-1 bg-white">
               <option value="cash" selected>üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
               <option value="qr">üì± QR Code</option>
               <option value="transfer">üè¶ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
             </select>
           </div>
        </div>

        {# Summary Box (‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô ‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤) #}
        <div class="card-clean bg-gray-50 border border-gray-200">
          <div class="card-body p-5">
            <h2 class="text-sm font-bold text-gray-500 uppercase mb-3 border-b border-gray-200 pb-2">üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</h2>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between text-gray-600"><span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</span><span class="font-bold text-gray-800" id="item-count">0</span></div>
              <div class="flex justify-between text-gray-600"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</span><span class="font-bold text-gray-800" id="total-qty">0</span></div>
              <div class="divider my-1"></div>
              <div class="flex justify-between items-center">
                  <span class="text-gray-600">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                  <span class="font-bold text-lg text-gray-800" id="subtotal">0.00 ‡∏ø</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-orange-600">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
                <input type="number" id="discount-input" class="input input-bordered input-xs w-24 text-right text-orange-600 font-bold bg-white" 
                       value="0" min="0" step="0.01" oninput="updateSummary()">
              </div>
              
              <div class="bg-white p-3 rounded border border-gray-200 mt-2">
                  <div class="flex justify-between items-end">
                    <span class="text-sm font-bold text-green-600 uppercase">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</span>
                    <span class="text-2xl font-bold text-green-700 leading-none" id="grand-total">0.00 ‡∏ø</span>
                  </div>
              </div>
            </div>
          </div>
        </div>

        {# Action Buttons #}
        <div class="card-clean p-4 space-y-2">
            <button onclick="openHoldModal()" class="btn btn-warning btn-block text-white">‚è∏Ô∏è ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•</button>
            <button id="checkout-btn" class="btn btn-primary btn-block shadow-md">üí≥ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
            <div class="grid grid-cols-2 gap-2 pt-2">
              <button id="clear-cart-btn" class="btn btn-outline btn-sm border-gray-300 text-gray-500 hover:bg-gray-50 hover:border-gray-400">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
        </div>

      </div>
    </div>
  </main>
</div>

{# Modals (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) #}
{% include "products/sales/modals/payment_cash.html" %}
{% include "products/sales/modals/payment_qr.html" %}
{% include "products/sales/modals/payment_transfer.html" %}

<dialog id="hold_modal" class="modal">
  <div class="modal-box bg-white rounded-xl">
    <h3 class="font-bold text-lg text-warning">‚è∏Ô∏è ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•</h3>
    <p class="py-4 text-gray-600">‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</p>
    <input type="text" id="hold_note" class="input input-bordered w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÅ‡∏î‡∏á">
    <div class="modal-action">
      <form method="dialog"><button class="btn btn-ghost text-gray-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></form>
      <button class="btn btn-warning text-white" onclick="confirmHoldBill()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/20"><button></button></form>
</dialog>

<dialog id="held_bills_modal" class="modal">
  <div class="modal-box w-11/12 max-w-4xl bg-white rounded-xl p-0 overflow-hidden">
    <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100 bg-gray-50">
      <h3 class="font-bold text-lg text-gray-700">üìã ‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ</h3>
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost text-gray-400">‚úï</button></form>
    </div>
    <div class="overflow-x-auto p-4">
      <table class="table table-clean w-full">
        <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th class="text-right">‡∏¢‡∏≠‡∏î</th><th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
        <tbody id="held-bills-list">
          <tr><td colspan="5" class="text-center py-8"><span class="loading loading-spinner text-primary"></span></td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/20"><button></button></form>
</dialog>

{# JavaScript Logic (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° 100%) #}
<script>
// ========== Global Variables ==========
let cart = [];
let searchResultProducts = [];
let currentPriceType = 'retail';
let customerCar = '';
const docNo = "{{ doc_no }}";
const searchUrl = "{% url 'search_products_ajax' %}";
const createSaleUrl = "{% url 'create_sale' %}";
const csrfToken = "{{ csrf_token }}";
let currentSaleId = null;

// ========== Clock ==========
function updateClock() {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString('th-TH');
}
setInterval(updateClock, 1000);
updateClock();

// ========== Car Filter ==========
function updateCarFilter() { customerCar = document.getElementById('customer-car').value.trim(); }
function clearCarFilter() { document.getElementById('customer-car').value = ''; customerCar = ''; }

// ========== Search ==========
async function searchProducts() {
  const q = document.getElementById('search-input').value.trim();
  if (!q) { document.getElementById('search-results').classList.add('hidden'); return; }
  
  try {
    const response = await fetch(`${searchUrl}?q=${encodeURIComponent(q)}`);
    const data = await response.json();
    displaySearchResults(data.products || []);
  } catch (error) {
    console.error('Search error:', error);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
  }
}

function displaySearchResults(products) {
  const container = document.getElementById('result-container');
  const resultsDiv = document.getElementById('search-results');
  searchResultProducts = products;
  
  let filtered = customerCar 
    ? products.filter(p => p.compatible_models?.toLowerCase().includes(customerCar.toLowerCase()))
    : products;
  
  if (filtered.length === 0) {
    container.innerHTML = '<div class="col-span-2 text-center py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';
    resultsDiv.classList.remove('hidden');
    document.getElementById('result-count').textContent = '0';
    return;
  }
  
  document.getElementById('result-count').textContent = filtered.length;
  resultsDiv.classList.remove('hidden');
  
  container.innerHTML = filtered.map(p => {
    const price = currentPriceType === 'wholesale' ? p.wholesale_price : p.selling_price;
    const badge = getBundleBadge(p);
    const pairInfo = getPairInfo(p);
    const originalIndex = products.findIndex(prod => prod.id === p.id);
    
    return `
      <button class="btn btn-outline btn-sm justify-start gap-2 h-auto py-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 text-gray-700" onclick="addToCartByIndex(${originalIndex})">
        <div class="text-left flex-1 min-w-0">
          ${badge}
          <div class="font-mono text-xs font-bold text-blue-600">${p.sku}</div>
          <div class="text-xs font-semibold truncate text-gray-800">${p.name}</div>
          ${pairInfo}
          <div class="text-xs font-bold text-green-600">‡∏ø${parseFloat(price).toFixed(2)}</div>
        </div>
        <div class="badge badge-sm ${p.has_stock ? 'badge-success text-white' : 'badge-error text-white'}">
          ${p.has_stock ? parseFloat(p.stock_units).toFixed(0) : '‡∏´‡∏°‡∏î'}
        </div>
      </button>
    `;
  }).join('');
}

// ========== Bundle Badge & Pair Info ==========
function getBundleBadge(p) {
  if (!p.bundle_group || p.bundle_type === 'SAME') return '';
  
  let [color, text, icon] = ['', '', ''];
  
  // ‡∏Å‡∏£‡∏ì‡∏µ ‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ (L-R)
  if (p.bundle_type === 'L-R') {
    if (p.sku.includes('-L') || p.name.includes('‡∏ã‡πâ‡∏≤‡∏¢')) {
        [color, text, icon] = ['badge-info', '‡∏ã‡πâ‡∏≤‡∏¢', '‚Üê'];
    } else if (p.sku.includes('-R') || p.name.includes('‡∏Ç‡∏ß‡∏≤')) {
        [color, text, icon] = ['badge-error', '‡∏Ç‡∏ß‡∏≤', '‚Üí'];
    } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≤‡∏á = ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "‡∏ä‡∏∏‡∏î/‡∏Ñ‡∏π‡πà"
        return '<span class="badge badge-primary badge-xs text-white mr-1"> ‡∏ä‡∏∏‡∏î</span>';
    }
  } 
  // ‡∏Å‡∏£‡∏ì‡∏µ ‡∏´‡∏ô‡πâ‡∏≤-‡∏´‡∏•‡∏±‡∏á (F-R)
  else if (p.bundle_type === 'F-R') {
    if (p.sku.includes('-F') || p.name.includes('‡∏´‡∏ô‡πâ‡∏≤')) {
        [color, text, icon] = ['badge-warning', '‡∏´‡∏ô‡πâ‡∏≤', '‚Üë'];
    } else if (p.sku.includes('-R') || p.name.includes('‡∏´‡∏•‡∏±‡∏á')) {
        [color, text, icon] = ['badge-secondary', '‡∏´‡∏•‡∏±‡∏á', '‚Üì'];
    } else {
        return '<span class="badge badge-primary badge-xs text-white mr-1"> ‡∏ä‡∏∏‡∏î</span>';
    }
  }
  
  if (!text) return '';
  return `<span class="badge ${color} badge-xs text-white mr-1">${icon} ${text}</span>`;
}

function getPairInfo(p) {
  if (!p.has_pair) return '';
  const text = p.bundle_type === 'L-R' ? '‡∏Ñ‡∏π‡πà' : '‡∏ä‡∏∏‡∏î';
  return `<div class="text-[10px] text-green-600 mt-0.5">‚úì ‡∏°‡∏µ${text}‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</div>`;
}

// ========== Cart Management ==========
function addToCartByIndex(idx) { if (searchResultProducts[idx]) addToCart(searchResultProducts[idx]); }

function addToCart(p) {
  if (!p.has_stock) { alert(`${p.name} ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å`); return; }
  
  const price = currentPriceType === 'wholesale' ? p.wholesale_price : p.selling_price;
  const existing = cart.find(item => item.id === p.id);
  
  if (existing) {
    if (existing.quantity + 1 > p.stock_units) {
      alert(`‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${parseFloat(p.stock_units).toFixed(0)} ${p.unit}`);
      return;
    }
    existing.quantity++;
  } else {
    cart.push({
      id: p.id, sku: p.sku, name: p.name, unit: p.unit,
      price: parseFloat(price), selling_price: parseFloat(p.selling_price),
      wholesale_price: parseFloat(p.wholesale_price), stock_units: parseFloat(p.stock_units),
      quantity: 1, original_price: parseFloat(price),
      bundle_type: p.bundle_type, bundle_group: p.bundle_group, has_pair: p.has_pair
    });
  }
  
  renderCart();
  
  // Clear search
  const searchInput = document.getElementById('search-input');
  if (searchInput) {
      searchInput.value = '';
      searchInput.focus();
  }
  document.getElementById('search-results').classList.add('hidden');
  
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°
  setTimeout(() => checkPairInCart(), 300);
  
  // ‚≠ê ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏π‡πà (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤)
  if (p.bundle_group && p.has_pair) suggestPairProduct(p);
}

function changeQty(idx, delta) {
  const item = cart[idx];
  const newQty = item.quantity + delta;
  if (newQty < 1) return;
  if (newQty > item.stock_units) { alert(`‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.stock_units.toFixed(0)}`); return; }
  item.quantity = newQty;
  renderCart();
}

function setQty(idx, val) {
  const item = cart[idx];
  const qty = parseFloat(val);
  if (isNaN(qty) || qty < 1) item.quantity = 1;
  else if (qty > item.stock_units) { alert(`‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.stock_units.toFixed(0)}`); item.quantity = item.stock_units; }
  else item.quantity = qty;
  renderCart();
}

function removeItem(idx) {
  if (confirm(`‡∏•‡∏ö ${cart[idx].name}?`)) { cart.splice(idx, 1); renderCart(); }
}

function clearCart() {
  if (cart.length > 0 && confirm('‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?')) { currentSaleId = null; cart = []; renderCart(); }
}

function renderCart() {
  const tbody = document.getElementById('cart-items');
  if (cart.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-12 text-gray-300"><div class="text-4xl opacity-30 mb-2">üõí</div><div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div></td></tr>';
  } else {
    tbody.innerHTML = cart.map((item, idx) => `
      <tr class="hover:bg-gray-50">
        <td class="text-center text-gray-400 text-xs">${idx + 1}</td>
        <td class="font-mono text-xs font-bold text-blue-600">${item.sku}</td>
        <td class="text-sm text-gray-700">
            ${item.name}
            ${item.unit_type === '‡∏Ñ‡∏π‡πà' ? '<span class="badge badge-xs badge-info text-white ml-1">‡∏Ñ‡∏π‡πà</span>' : ''}
        </td>
        <td>
          <div class="join flex justify-center">
            <button class="btn btn-xs join-item btn-ghost border border-gray-200" onclick="changeQty(${idx}, -1)">-</button>
            <input type="number" class="input input-xs join-item w-12 text-center bg-white border-t border-b border-gray-200" 
                   value="${item.quantity}" onchange="setQty(${idx}, this.value)">
            <button class="btn btn-xs join-item btn-ghost border border-gray-200" onclick="changeQty(${idx}, 1)">+</button>
          </div>
        </td>
        <td class="text-right text-gray-600 text-sm">${item.price.toFixed(2)}</td>
        <td class="text-right font-bold text-gray-800 text-sm">${(item.quantity * item.price).toFixed(2)}</td>
        <td class="text-center"><button class="btn btn-ghost btn-xs text-gray-400 hover:text-red-500" onclick="removeItem(${idx})">‚úï</button></td>
      </tr>
    `).join('');
  }
  updateSummary();
}

function updateSummary() {
  const itemCount = cart.length;
  const totalQty = cart.reduce((sum, item) => sum + item.quantity, 0);
  const subtotal = cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
  const discount = parseFloat(document.getElementById('discount-input').value) || 0;
  const grandTotal = subtotal - discount;
  
  document.getElementById('item-count').textContent = `${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  document.getElementById('total-qty').textContent = `${totalQty.toFixed(0)} ‡∏ä‡∏¥‡πâ‡∏ô`;
  document.getElementById('subtotal').textContent = `${subtotal.toFixed(2)} ‡∏ø`;
  document.getElementById('grand-total').textContent = `${grandTotal.toFixed(2)} ‡∏ø`;
}

// ========== Pair Suggestion ==========
async function suggestPairProduct(p) {
  try {
    const res = await fetch(`/api/get-pair-products/?product_id=${p.id}`);
    const data = await res.json();
    if (data.success && data.has_pair && data.pairs.length > 0) {
        const pairNotInCart = data.pairs.filter(pair => !cart.some(c => c.id === pair.id));
        if (pairNotInCart.length > 0) {
            showPairModal(p, pairNotInCart);
        }
    }
  } catch (e) { console.error('Pair error:', e); }
}

function showPairModal(current, pairs) {
  const text = current.bundle_type === 'L-R' ? '‡∏Ñ‡∏π‡πà' : '‡∏ä‡∏∏‡∏î';
  const html = `
    <div id="pair-modal" class="modal modal-open">
      <div class="modal-box bg-white">
        <h3 class="font-bold text-lg mb-4 text-gray-800">‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° "${current.name}" ‡πÅ‡∏•‡πâ‡∏ß</h3>
        <div class="alert alert-info bg-blue-50 border-blue-100 text-blue-700 mb-4 text-sm">
            <span>üí° ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°${text}‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏´‡∏°?</span>
        </div>
        ${pairs.map(pair => `
          <div class="flex justify-between p-3 bg-gray-50 border border-gray-100 rounded mb-2">
            <div><div class="font-semibold text-gray-700 text-sm">${pair.name}</div><div class="text-xs text-gray-500">‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${pair.quantity}</div></div>
            <div class="text-right">
              <div class="font-bold text-gray-800 text-sm">‡∏ø${pair.selling_price}</div>
              <button onclick="addPairToCart(${pair.id}); closePairModal();" class="btn btn-sm btn-primary mt-1 text-white">‚ûï</button>
            </div>
          </div>
        `).join('')}
        <div class="modal-action"><button onclick="closePairModal()" class="btn btn-ghost text-gray-500">‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤</button></div>
      </div>
    </div>
  `;
  const existing = document.getElementById('pair-modal');
  if (existing) existing.remove();
  document.body.insertAdjacentHTML('beforeend', html);
}

function closePairModal() {
  const modal = document.getElementById('pair-modal');
  if (modal) modal.remove();
}

async function addPairToCart(productId) {
  await fetchProductAndAdd(productId);
}

// ========== Payment & Save ==========
function openPaymentModal() {
  if (cart.length === 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'); return; }
  const method = document.getElementById('payment-method-select').value;
  if (method === 'cash') openCashModal();
  else if (method === 'qr') openQRModal();
  else if (method === 'transfer') openTransferModal();
}
//‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≤‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
async function saveSaleWithPayment() {
  const discount = parseFloat(document.getElementById('discount-input').value) || 0;
  const paymentData = window.paymentData || {};
  
  const data = {
      sale_id: currentSaleId, doc_no: docNo, price_type: currentPriceType,
      payment_method: paymentData.method || 'cash', payment_received: paymentData.received || 0,
      discount_amount: discount, auto_post: true, status: 'POSTED',
      items: cart.map(item => ({ 
          product_id: item.id, 
          quantity: item.quantity, 
          custom_price: item.price,
          unit_type: item.unit_type || '‡∏ä‡∏¥‡πâ‡∏ô',
          bundle_items: item.bundle_items || null
      }))
    };
  
  try {
    const res = await fetch(createSaleUrl, {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
      body: JSON.stringify(data)
    });
    const result = await res.json();
    
    if (result.success) {
      currentSaleId = null;
      const change = result.payment_change || 0;
      alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${result.doc_no}\n‡∏¢‡∏≠‡∏î: ${result.grand_total.toFixed(2)} ‡∏ø` +
        (paymentData.method === 'cash' ? `\n‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô: ${paymentData.received.toFixed(2)} ‡∏ø\n‡∏ó‡∏≠‡∏ô: ${change.toFixed(2)} ‡∏ø` : ''));
      window.location.href = result.redirect_url;
    } else {
      alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n${result.error}`);
    }
  } catch (error) {
    console.error('Save error:', error);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
  }
}

// ========== Hold Bill ==========
function openHoldModal() {
  if (cart.length === 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'); return; }
  document.getElementById('hold_modal').showModal();
  setTimeout(() => document.getElementById('hold_note').focus(), 100);
}

async function confirmHoldBill() {
  const note = document.getElementById('hold_note').value.trim();
  const discount = parseFloat(document.getElementById('discount-input').value) || 0;
  
  const data = {
    doc_no: docNo, remark: note, discount_amount: discount, price_type: currentPriceType,
    auto_post: false, status: 'HOLD',
    items: cart.map(item => ({ product_id: item.id, quantity: item.quantity, custom_price: item.price }))
  };
  
  try {
    const res = await fetch(createSaleUrl, {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
      body: JSON.stringify(data)
    });
    const result = await res.json();
    
    if (result.success) {
      document.getElementById('hold_modal').close();
      alert(`‚úÖ ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n${result.doc_no}`);
      window.location.reload();
    } else {
      alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.error}`);
    }
  } catch (error) {
    console.error('Hold error:', error);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
  }
}

async function loadHeldBills() {
  const modal = document.getElementById('held_bills_modal');
  const tbody = document.getElementById('held-bills-list');
  modal.showModal();
  tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8"><span class="loading loading-spinner text-primary"></span></td></tr>';

  try {
    const res = await fetch('/sales/api/held-bills/');
    const data = await res.json();

    if (data.success) {
      updateHeldBadge(data.bills.length);
      if (data.bills.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
        return;
      }

      tbody.innerHTML = data.bills.map(bill => `
        <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-b-0">
          <td class="font-mono text-xs text-gray-500 pl-4">${bill.date} ‡∏ô.</td>
          <td class="font-bold text-gray-700 text-sm">${bill.doc_no}</td>
          <td class="text-gray-600 text-sm">${bill.remark}</td>
          <td class="text-right font-bold text-gray-800 text-sm">
            ${bill.total.toLocaleString()} ‡∏ø
            <div class="text-[10px] text-gray-400 font-normal">(${bill.items_count} ‡∏ä‡∏¥‡πâ‡∏ô)</div>
          </td>
          <td class="text-center">
            <div class="join">
              <button onclick="resumeBill(${bill.id})" class="btn btn-xs btn-success join-item text-white" title="‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠">‚ñ∂</button>
              <button onclick="discardBill(${bill.id})" class="btn btn-xs btn-error join-item text-white" title="‡∏•‡∏ö">üóë</button>
            </div>
          </td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-error">Error: ${data.error}</td></tr>`;
    }
  } catch (error) {
    console.error('Load held bills error:', error);
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-error">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</td></tr>';
  }
}

function updateHeldBadge(count) {
  const badge = document.getElementById('held-count-badge');
  badge.textContent = count;
  badge.classList.toggle('hidden', count === 0);
}

async function resumeBill(saleId) {
  if (cart.length > 0 && !confirm('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á?')) return;

  try {
    const res = await fetch(`/sales/api/resume/${saleId}/`);
    const data = await res.json();

    if (data.success) {
      currentSaleId = saleId;
      cart = data.sale.items.map(item => ({
        id: item.id, sku: item.sku, name: item.name, unit: item.unit,
        price: item.price, selling_price: item.selling_price, wholesale_price: item.wholesale_price,
        stock_units: item.stock_units, quantity: item.quantity, original_price: item.original_price
      }));

      document.getElementById('discount-input').value = data.sale.discount;
      const docNoEl = document.getElementById('doc-no');
      if (docNoEl) docNoEl.textContent = data.sale.doc_no;

      renderCart();
      document.getElementById('held_bills_modal').close();
    } else {
      alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: ' + data.error);
    }
  } catch (error) {
    console.error('Resume error:', error);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
  }
}

async function discardBill(saleId) {
  if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏û‡∏±‡∏Å?')) return;

  try {
    const res = await fetch(`/sales/api/discard/${saleId}/`, {
      method: 'POST', headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    if (data.success) loadHeldBills();
    else alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + data.error);
  } catch (error) {
    console.error('Discard error:', error);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
  }
}

// ========== Event Listeners ==========
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('product_id');
  const autoAdd = urlParams.get('auto_add');
  if (productId && autoAdd === '1') fetchProductAndAdd(productId);
  
  document.getElementById('search-input').addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); searchProducts(); }});
  document.getElementById('search-btn').addEventListener('click', searchProducts);
  document.getElementById('checkout-btn').addEventListener('click', openPaymentModal);
  document.getElementById('clear-cart-btn').addEventListener('click', clearCart);
  
  document.getElementById('price-type-select').addEventListener('change', function() {
    const newType = this.value;
    if (cart.length > 0 && confirm('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤?')) {
      currentPriceType = newType;
      cart.forEach(item => {
        if (item.price === item.original_price) {
          const newPrice = newType === 'wholesale' ? item.wholesale_price : item.selling_price;
          item.price = item.original_price = newPrice;
        }
      });
      renderCart();
    } else if (cart.length === 0) {
      currentPriceType = newType;
    } else {
      this.value = currentPriceType;
    }
  });
  
  renderCart();
  setTimeout(loadHeldBills, 500);
});
// ========== Auto Add from URL ==========
async function fetchProductAndAdd(productId) {
  try {
    const res = await fetch(`/api/products/${productId}/`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
    if (!data.has_stock) { alert(`‚ùå "${data.name}" ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å`); return; }
    addToCart(data);
  } catch (error) {
    console.error('Auto add error:', error);
    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
  } finally {
    // Clean URL params if exists
    const url = new URL(window.location);
    if (url.searchParams.has('product_id')) {
        url.searchParams.delete('product_id');
        url.searchParams.delete('auto_add');
        window.history.replaceState({}, '', url);
    }
  }
}
function checkPairInCart() {
    const groups = {};
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° bundle_group
    cart.forEach((item, index) => {
        if (item.bundle_group && item.bundle_type === 'L-R') {
            if (!groups[item.bundle_group]) {
                groups[item.bundle_group] = [];
            }
            groups[item.bundle_group].push({item, index});
        }
    });
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏´‡∏ô‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö L+R
    for (const [group, items] of Object.entries(groups)) {
        if (items.length === 2) {
            // ‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÅ‡∏™‡∏î‡∏á Popup
            showBundlePopup(items);
        }
    }
}
// ‚≠ê Popup ‡∏ñ‡∏≤‡∏°‡∏£‡∏ß‡∏°‡∏Ñ‡∏π‡πà
function showBundlePopup(items) {
    const item1 = items[0].item;
    const item2 = items[1].item;
    const totalPrice = item1.price + item2.price;
    
    const html = `
        <div id="bundle-popup" class="modal modal-open">
            <div class="modal-box bg-white">
                <h3 class="font-bold text-lg mb-4 text-gray-800">üí° ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡πÑ‡∏´‡∏°?</h3>
                
                <div class="space-y-2 mb-4 text-gray-600">
                    <div class="flex justify-between">
                        <span>‚Ä¢ ${item1.name}</span>
                        <span>‡∏ø${item1.price}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‚Ä¢ ${item2.name}</span>
                        <span>‡∏ø${item2.price}</span>
                    </div>
                    <div class="divider my-2"></div>
                    <div class="flex justify-between font-bold text-gray-800">
                        <span>‡∏£‡∏ß‡∏° (‡∏Ñ‡∏π‡πà)</span>
                        <span>‡∏ø${totalPrice}</span>
                    </div>
                </div>
                
                <div class="alert bg-blue-50 text-blue-700 text-sm border border-blue-100">
                    <span>üí∞ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏™‡πà‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ</span>
                </div>
                
                <div class="modal-action">
                    <button onclick="closeBundlePopup()" class="btn btn-ghost text-gray-500">‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°</button>
                    <button onclick="mergeToPair(${items[0].index}, ${items[1].index})" 
                            class="btn btn-primary text-white">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', html);
}

function closeBundlePopup() {
    const popup = document.getElementById('bundle-popup');
    if (popup) popup.remove();
}
// ‚≠ê ‡∏£‡∏ß‡∏° 2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà
function mergeToPair(index1, index2) {
    const item1 = cart[index1];
    const item2 = cart[index2];
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
    const totalSelling = item1.selling_price + item2.selling_price;
    const totalWholesale = item1.wholesale_price + item2.wholesale_price;
    const minStock = Math.min(item1.stock_units, item2.stock_units);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (‡∏Ñ‡∏π‡πà)
    const bundleItem = {
        id: item1.id, 
        sku: item1.bundle_group,
        name: item1.name.replace(/\(‡∏ã‡πâ‡∏≤‡∏¢\)|\(‡∏Ç‡∏ß‡∏≤\)/g, '').trim(),
        
        // ‚úÖ 1. ‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        price: item1.price + item2.price,
        original_price: item1.original_price + item2.original_price,
        
        // ‚úÖ 2. ‡πÉ‡∏™‡πà‡∏ê‡∏≤‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏õ‡∏•‡∏µ‡∏Å/‡∏™‡πà‡∏á ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏≤‡∏¢)
        selling_price: totalSelling,
        wholesale_price: totalWholesale,
        
        quantity: 1,
        unit_type: '‡∏Ñ‡∏π‡πà',
        bundle_items: [item1.id, item2.id],
        
        // ‚úÖ 3. ‡πÉ‡∏™‡πà‡∏™‡∏ï‡πá‡∏≠‡∏Å
        stock_units: minStock,
        has_stock: minStock > 0
    };
    
    // ‡∏•‡∏ö 2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°
    const toRemove = [index1, index2].sort((a,b) => b-a);
    toRemove.forEach(i => cart.splice(i, 1));
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡πà
    cart.push(bundleItem);
    
    renderCart();
    closeBundlePopup();
}
</script>

</body>
</html>