{% load tailwind_tags %}
<!doctype html>
<html lang="th" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>üõí ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
  {% tailwind_css %}
  <style>
      /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Animation ‡πÉ‡∏´‡πâ Badge ‡πÄ‡∏î‡πâ‡∏á‡∏î‡∏∂‡πã‡∏á */
      @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-3px); }
      }
      .badge-bounce {
        animation: bounce 1s infinite;
      }
  </style>
</head>
<body class="bg-base-200">
<div class="flex min-h-screen">

  {# Sidebar #}
  {% include "partials/sidebar.html" %}

  {# Main Content #}
  <main class="flex-1 flex flex-col h-screen overflow-hidden">
    
    {# ========== Header ========== #}
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 shadow-lg">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div>
            <h1 class="text-2xl font-bold">üõí ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
            <p class="text-xs opacity-90">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: <span id="doc-no" class="font-mono font-bold">{{ doc_no }}</span></p>
          </div>
        </div>
        
        <div class="flex items-center gap-3">
            <button onclick="loadHeldBills()" class="btn btn-sm btn-warning text-white gap-2 relative border-none hover:bg-yellow-600">
                <span>üìã ‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ</span>
                <span id="held-count-badge" class="badge badge-error badge-sm absolute -top-1 -right-1 hidden badge-bounce">0</span>
            </button>

            <div class="stats shadow bg-white/20 text-white">
              <div class="stat py-2 px-4">
                <div class="stat-title text-white/80 text-xs">‡πÄ‡∏ß‡∏•‡∏≤</div>
                <div class="stat-value text-xl" id="clock">00:00:00</div>
              </div>
            </div>
        </div>
      </div>
    </div>

    {# ========== Body ========== #}
    <div class="flex-1 flex gap-3 p-3 overflow-hidden">
      
      {# ========== ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ========== #}
      <div class="flex-1 flex flex-col gap-3 min-w-0">
        
        {# ‡∏£‡∏ñ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ #}
        <div class="card bg-gradient-to-r from-orange-50 to-yellow-50 shadow">
          <div class="card-body p-3">
            <div class="flex items-center gap-2">
              <span class="text-base">üöó</span>
              <input type="text" 
                     id="customer-car"
                     class="input input-bordered input-sm flex-1" 
                     placeholder="‡∏£‡∏ñ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Vios 2012)"
                     onchange="updateCarFilter()">
              <button onclick="clearCarFilter()" class="btn btn-ghost btn-xs">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
          </div>
        </div>
        
        {# ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ #}
        <div class="card bg-white shadow">
          <div class="card-body p-4">
            <h2 class="text-lg font-bold mb-2">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            
            <div class="flex gap-2">
              <input type="text" 
                     id="search-input"
                     class="input input-bordered flex-1 font-mono" 
                     placeholder="SKU, ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ..."
                     autofocus>
              <button id="search-btn" class="btn btn-primary gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              </button>
            </div>

            {# ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ #}
            <div id="search-results" class="mt-3 hidden">
              <div class="text-xs text-gray-500 mb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (<span id="result-count">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
              <div id="result-container" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto"></div>
            </div>
          </div>
        </div>

        {# ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ #}
        <div class="card bg-white shadow flex-1 overflow-hidden flex flex-col min-h-0">
          <div class="card-body p-4 flex flex-col flex-1 overflow-hidden min-h-0">
            <h2 class="text-lg font-bold mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            
            <div class="flex-1 overflow-y-auto min-h-0">
              <table class="table table-zebra table-xs table-pin-rows">
                <thead class="bg-base-200">
                  <tr>
                    <th class="w-8">#</th>
                    <th class="w-24">SKU</th>
                    <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th class="text-center w-32">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th class="text-right w-24">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                    <th class="text-right w-20">‡∏£‡∏ß‡∏°</th>
                    <th class="w-8"></th>
                  </tr>
                </thead>
                <tbody id="cart-items">
                  <tr id="empty-cart">
                    <td colspan="7" class="text-center py-8">
                      <div class="text-4xl mb-2 opacity-30">üõí</div>
                      <div class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>

      {# ========== ‡∏Ç‡∏ß‡∏≤: ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î ========== #}
      <div class="w-80 flex flex-col gap-3 overflow-y-auto">
        
        {# ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤ #}
        <div class="card bg-white shadow">
          <div class="card-body p-4">
            <h2 class="text-base font-bold mb-2">üíé ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤</h2>
            <select id="price-type-select" class="select select-bordered w-full">
              <option value="retail" selected>üõçÔ∏è ‡∏Ç‡∏≤‡∏¢‡∏õ‡∏•‡∏µ‡∏Å</option>
              <option value="wholesale">üì¶ ‡∏Ç‡∏≤‡∏¢‡∏™‡πà‡∏á</option>
            </select>
          </div>
        </div>

        {# ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô #}
        <div class="card bg-white shadow">
          <div class="card-body p-4">
            <h2 class="text-base font-bold mb-2">üí≥ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</h2>
            <select id="payment-method-select" class="select select-bordered w-full">
              <option value="cash" selected>üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
              <option value="qr">üì± QR Code</option>
              <option value="transfer">üè¶ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
            </select>
          </div>
        </div>

        {# ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î #}
        <div class="card bg-gradient-to-br from-blue-50 to-purple-50 shadow">
          <div class="card-body p-4">
            <h2 class="text-lg font-bold mb-3">üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</h2>
            
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</span>
                <span class="font-bold" id="item-count">0</span>
              </div>
              
              <div class="flex justify-between">
                <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</span>
                <span class="font-bold" id="total-qty">0</span>
              </div>
              
              <div class="divider my-1"></div>
              
              <div class="flex justify-between">
                <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                <span class="font-bold text-lg" id="subtotal">0.00 ‡∏ø</span>
              </div>
              
              <div class="flex justify-between items-center">
                <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
                <input type="number" 
                       id="discount-input" 
                       class="input input-bordered input-xs w-24 text-right" 
                       value="0" 
                       min="0" 
                       step="0.01"
                       oninput="updateSummary()">
              </div>
              
              <div class="divider my-1"></div>
              
              <div class="flex justify-between text-lg font-bold">
                <span class="text-success">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞:</span>
                <span class="text-success" id="grand-total">0.00 ‡∏ø</span>
              </div>
            </div>
          </div>
        </div>

        {# ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ #}
        <div class="card bg-white shadow">
          <div class="card-body p-4">
            
            <button onclick="openHoldModal()" class="btn btn-warning btn-lg w-full mb-2 text-white shadow-md">
                <span class="text-xl">‚è∏Ô∏è</span> ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏• (Hold)
            </button>

            <button id="checkout-btn" class="btn btn-success btn-lg w-full gap-2 text-white mb-2">
              üí≥ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            </button>
            
            <div class="flex gap-2">
              <button id="clear-cart-btn" class="btn btn-outline btn-sm flex-1">
                üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á
              </button>
              <a href="{% url 'sales_report' %}" class="btn btn-ghost btn-sm flex-1">
                üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
              </a>
            </div>
          </div>
        </div>

      </div>

    </div>

  </main>
</div>

{# ‚úÖ Include Modals #}
{% include "products/sales/modals/payment_cash.html" %}
{% include "products/sales/modals/payment_qr.html" %}
{% include "products/sales/modals/payment_transfer.html" %}


<dialog id="hold_modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-warning flex items-center gap-2">
        <span>‚è∏Ô∏è</span> ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
    </h3>
    <p class="py-4 text-gray-600">‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏≥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</p>
    
    <div class="form-control">
      <input type="text" id="hold_note" 
             class="input input-bordered w-full" 
             placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÅ‡∏î‡∏á, ‡∏£‡∏≠‡πÅ‡∏ü‡∏ô, ‡∏•‡∏∑‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏±‡∏á">
    </div>

    <div class="modal-action">
      <form method="dialog">
        <button class="btn btn-ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </form>
      <button class="btn btn-warning text-white" onclick="confirmHoldBill()">
          ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>


<dialog id="held_bills_modal" class="modal">
  <div class="modal-box w-11/12 max-w-4xl"> <div class="flex justify-between items-center mb-4 border-b pb-2">
        <h3 class="font-bold text-lg flex items-center gap-2">
            <span>üìã</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ
        </h3>
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost">‚úï</button>
        </form>
    </div>

    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <thead class="bg-base-200">
          <tr>
            <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
            <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            <th class="text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
            <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="held-bills-list">
            <tr>
                <td colspan="5" class="text-center text-gray-500 py-8">
                    <span class="loading loading-spinner loading-md"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                </td>
            </tr>
        </tbody>
      </table>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>


{# ========== JavaScript ========== #}
<script>
// ===================================
// Global Variables
// ===================================
let cart = [];
let searchResultProducts = [];
let currentPriceType = 'retail';
let customerCar = '';
const docNo = "{{ doc_no }}";
const searchUrl = "{% url 'search_products_ajax' %}";
const createSaleUrl = "{% url 'create_sale' %}";
const csrfToken = "{{ csrf_token }}";
let currentSaleId = null;

// ===================================
// ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤
// ===================================
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString('th-TH');
}

updateClock();
setInterval(updateClock, 1000);

// ===================================
// ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏ñ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
// ===================================
function updateCarFilter() {
  customerCar = document.getElementById('customer-car').value.trim();
}

function clearCarFilter() {
  document.getElementById('customer-car').value = '';
  customerCar = '';
}

// ===================================
// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
// ===================================
async function searchProducts() {
  const q = document.getElementById('search-input').value.trim();
  
  if (!q) {
    document.getElementById('search-results').classList.add('hidden');
    return;
  }
  
  try {
    const response = await fetch(`${searchUrl}?q=${encodeURIComponent(q)}`);
    const data = await response.json();
    
    displaySearchResults(data.products || []);
  } catch (error) {
    console.error('Search error:', error);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
  }
}

function displaySearchResults(products) {
  const container = document.getElementById('result-container');
  const resultsDiv = document.getElementById('search-results');
  const countSpan = document.getElementById('result-count');
  
  searchResultProducts = products;
  
  let filteredProducts = products;
  
  // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏ñ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if (customerCar) {
    filteredProducts = products.filter(p => {
      if (!p.compatible_models) return false;
      return p.compatible_models.toLowerCase().includes(customerCar.toLowerCase());
    });
  }
  
  if (!filteredProducts || filteredProducts.length === 0) {
    container.innerHTML = '<div class="col-span-2 text-center py-4 text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';
    resultsDiv.classList.remove('hidden');
    countSpan.textContent = '0';
    return;
  }
  
  countSpan.textContent = filteredProducts.length;
  resultsDiv.classList.remove('hidden');
  
  container.innerHTML = filteredProducts.map((p, index) => {
    const displayPrice = currentPriceType === 'wholesale' 
      ? parseFloat(p.wholesale_price).toFixed(2)
      : parseFloat(p.selling_price).toFixed(2);
    
    let matchBadge = '';
    if (p.match_type === 'exact_sku') matchBadge = '<span class="badge badge-success badge-xs">SKU</span>';
    else if (p.match_type === 'name') matchBadge = '<span class="badge badge-warning badge-xs">‡∏ä‡∏∑‡πà‡∏≠</span>';
    else if (p.match_type === 'car') matchBadge = '<span class="badge badge-secondary badge-xs">‡∏£‡∏ñ</span>';
    
    // ‡∏´‡∏≤ Index ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Array ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
    const originalIndex = products.findIndex(prod => prod.id === p.id);
    
    const carModelsHtml = p.compatible_models 
      ? `<div class="text-[10px] text-gray-500 truncate mt-0.5" title="${p.compatible_models}">
           üöó ${p.compatible_models}
         </div>` 
      : '';

    return `
      <button class="btn btn-outline btn-sm justify-start gap-2 h-auto py-2 hover:btn-primary" 
              onclick="addToCartByIndex(${originalIndex})">
        <div class="text-left flex-1 min-w-0">
          <div class="flex items-center gap-1 mb-1">
            <span class="font-mono text-xs truncate font-bold text-primary">${p.sku}</span>
            ${matchBadge}
          </div>
          
          <div class="text-xs truncate font-semibold">${p.name}</div>
          
          ${carModelsHtml}
          
          <div class="text-xs font-bold text-success mt-1">‡∏ø${displayPrice}</div>
        </div>
        
        <div class="flex flex-col items-end gap-1">
            <div class="badge badge-sm ${p.has_stock ? 'badge-success' : 'badge-error'}">
              ${p.has_stock ? parseFloat(p.stock_units).toFixed(0) : '‡∏´‡∏°‡∏î'}
            </div>
        </div>
      </button>
    `;
  }).join('');
}

// ===================================
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
// ===================================
function addToCartByIndex(index) {
  if (!searchResultProducts[index]) return;
  addToCart(searchResultProducts[index]);
}

function addToCart(p) {
  if (!p.has_stock || p.stock_pieces <= 0) {
    alert(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${p.name} ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å`);
    return;
  }
  
  const existingIndex = cart.findIndex(item => item.id === p.id);
  const selectedPrice = currentPriceType === 'wholesale' 
    ? parseFloat(p.wholesale_price)
    : parseFloat(p.selling_price);
  
  if (existingIndex >= 0) {
    const item = cart[existingIndex];
    const newQty = item.quantity + 1;
    
    if (newQty > p.stock_units) {
      alert(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${p.name} ‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${parseFloat(p.stock_units).toFixed(0)} ${p.unit}`);
      return;
    }
    
    item.quantity = newQty;
  } else {
    cart.push({
      id: p.id,
      sku: p.sku,
      name: p.name,
      compatible_models: p.compatible_models || '',
      unit: p.unit,
      price: selectedPrice,
      selling_price: parseFloat(p.selling_price),
      wholesale_price: parseFloat(p.wholesale_price),
      stock_units: parseFloat(p.stock_units),
      quantity: 1,
      original_price: selectedPrice
    });
  }
  
  renderCart();
  
  document.getElementById('search-input').value = '';
  document.getElementById('search-results').classList.add('hidden');
  document.getElementById('search-input').focus();
}

// ===================================
// ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
// ===================================
function changeQty(index, delta) {
  const item = cart[index];
  const newQty = item.quantity + delta;
  
  if (newQty < 1) return;
  if (newQty > item.stock_units) {
    alert(`‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${item.stock_units.toFixed(0)} ${item.unit}`);
    return;
  }
  
  item.quantity = newQty;
  renderCart();
}

function setQty(index, value) {
  const item = cart[index];
  const qty = parseFloat(value);
  
  if (isNaN(qty) || qty < 1) {
    item.quantity = 1;
  } else if (qty > item.stock_units) {
    alert(`‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${item.stock_units.toFixed(0)} ${item.unit}`);
    item.quantity = item.stock_units;
  } else {
    item.quantity = qty;
  }
  
  renderCart();
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏Ñ‡∏≤
function updatePrice(index, value) {
  const item = cart[index];
  const price = parseFloat(value);
  
  if (isNaN(price) || price < 0) {
    alert('‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
    renderCart();
    return;
  }
  
  // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà
  item.price = price;
  renderCart();
}

function removeItem(index) {
  if (confirm(`‡∏•‡∏ö ${cart[index].name}?`)) {
    cart.splice(index, 1);
    renderCart();
  }
}

// ===================================
// 4. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô clearCart (‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏•‡πâ‡∏≤‡∏á)
// ===================================
function clearCart() {
  if (cart.length > 0 && confirm('‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
    currentSaleId = null; // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á ID ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏à‡∏∞‡πÄ‡∏ú‡∏•‡∏≠‡πÑ‡∏õ‡∏ó‡∏±‡∏ö‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤
    renderCart();
  }
}

// ===================================
// Render ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
// ===================================
function renderCart() {
  const tbody = document.getElementById('cart-items');
  
  if (cart.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center py-8">
          <div class="text-4xl mb-2 opacity-30">üõí</div>
          <div class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        </td>
      </tr>
    `;
  } else {
    tbody.innerHTML = cart.map((item, index) => {
      return `
        <tr class="hover">
          <td class="font-bold">${index + 1}</td>
          <td class="font-mono text-xs">${item.sku}</td>
          <td>
            <div class="font-semibold text-xs truncate">${item.name}</div>
            ${item.compatible_models ? `<div class="text-xs text-orange-600 truncate">üöó ${item.compatible_models}</div>` : ''}
          </td>
          <td>
            <div class="join join-horizontal">
              <button class="join-item btn btn-xs" onclick="changeQty(${index}, -1)">-</button>
              <input type="number" 
                     class="join-item input input-xs w-12 text-center" 
                     value="${item.quantity}" 
                     onchange="setQty(${index}, this.value)">
              <button class="join-item btn btn-xs" onclick="changeQty(${index}, 1)">+</button>
            </div>
          </td>
          
          <td class="text-right">
            ${item.price.toFixed(2)}
          </td>
          
          <td class="text-right font-bold text-sm">${(item.quantity * item.price).toFixed(2)}</td>
          <td>
            <button class="btn btn-ghost btn-xs text-error" onclick="removeItem(${index})">‚úï</button>
          </td>
        </tr>
      `;
    }).join('');
  }
  
  updateSummary();
}

// ===================================
// ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
// ===================================
function updateSummary() {
  const itemCount = cart.length;
  
  let totalQty = 0;
  let subtotal = 0;
  
  cart.forEach(item => {
    totalQty += item.quantity;
    subtotal += item.quantity * item.price; // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
  });
  
  const discount = parseFloat(document.getElementById('discount-input').value) || 0;
  const grandTotal = subtotal - discount;
  
  document.getElementById('item-count').textContent = `${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  document.getElementById('total-qty').textContent = `${totalQty.toFixed(0)} ‡∏ä‡∏¥‡πâ‡∏ô`;
  document.getElementById('subtotal').textContent = `${subtotal.toFixed(2)} ‡∏ø`;
  document.getElementById('grand-total').textContent = `${grandTotal.toFixed(2)} ‡∏ø`;
}

// ===================================
// ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
// ===================================
function openPaymentModal() {
  if (cart.length === 0) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤');
    return;
  }
  
  const method = document.getElementById('payment-method-select').value;
  
  if (method === 'cash') {
    openCashModal();
  } else if (method === 'qr') {
    openQRModal();
  } else if (method === 'transfer') {
    openTransferModal();
  }
}

// ===================================
// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏• (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Modal)
// ===================================
async function saveSaleWithPayment() {
  const discount = parseFloat(document.getElementById('discount-input').value) || 0;
  const paymentData = window.paymentData || {};
  
  const data = {
    sale_id: currentSaleId,
    doc_no: docNo,
    price_type: currentPriceType,
    payment_method: paymentData.method || 'cash',
    payment_received: paymentData.received || 0,
    discount_amount: discount,
    items: cart.map(item => ({
      product_id: item.id,
      quantity: item.quantity,
      custom_price: item.price
    })),
    auto_post: true,
    status: 'POSTED' // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  };
  
  console.log('üì§ Sending:', data);
  
  try {
    const response = await fetch(createSaleUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify(data)
    });
    
    console.log('üì• Status:', response.status);
    
    const result = await response.json();
    console.log('üì• Response:', result);
    
    if (result.success) {
      currentSaleId = null;
      
      // ‚úÖ ‡πÉ‡∏ä‡πâ payment_change ‡∏à‡∏≤‡∏Å Response
      const change = result.payment_change || 0;
      
      alert(
        `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n` +
        `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•: ${result.doc_no}\n` +
        `‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞: ${result.grand_total.toFixed(2)} ‡∏ö‡∏≤‡∏ó` +
        (paymentData.method === 'cash' ? 
          `\n‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô: ${paymentData.received.toFixed(2)} ‡∏ö‡∏≤‡∏ó\n` +
          `‡∏ó‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ${change.toFixed(2)} ‡∏ö‡∏≤‡∏ó` 
          : '')
      );
      
      window.location.href = result.redirect_url;
    } else {
      alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n${result.error}`);
    }
  } catch (error) {
    console.error('‚ùå Error:', error);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message);
  }
}

// ===================================
// ‚úÖ 1. ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•
// ===================================
function openHoldModal() {
    if (cart.length === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•');
        return;
    }
    document.getElementById('hold_modal').showModal();
    // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
    setTimeout(() => document.getElementById('hold_note').focus(), 100);
}

// ===================================
// ‚úÖ 2. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏• (‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Server)
// ===================================
async function confirmHoldBill() {
    const note = document.getElementById('hold_note').value.trim();
    const discount = parseFloat(document.getElementById('discount-input').value) || 0;
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡πÑ‡∏õ Backend
    const data = {
        doc_no: docNo, // ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        remark: note,  // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å
        discount_amount: discount,
        price_type: currentPriceType,
        items: cart.map(item => ({
            product_id: item.id,
            quantity: item.quantity,
            custom_price: item.price
        })),
        // ‚ö†Ô∏è ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•:
        auto_post: false, // ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å
        status: 'HOLD'    // ‡∏ö‡∏≠‡∏Å Backend ‡∏ß‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏∑‡∏≠ ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•
    };
    
    // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
    const btn = document.querySelector('#hold_modal .btn-warning');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="loading loading-spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

    try {
        const response = await fetch(createSaleUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // ‡∏õ‡∏¥‡∏î Modal
            document.getElementById('hold_modal').close();
            
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ß‡∏¢‡πÜ
            alert(`‚úÖ ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${result.doc_no}`);
            
            // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏ä‡πâ js clear ‡∏Ñ‡πà‡∏≤‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà reload ‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏•‡∏Ç doc_no)
            window.location.reload(); 
        } else {
            alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.error}`);
        }
    } catch (error) {
        console.error('Hold error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// ===================================
// ‚úÖ 3. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ
// ===================================
async function loadHeldBills() {
    const modal = document.getElementById('held_bills_modal');
    const tbody = document.getElementById('held-bills-list');
    
    modal.showModal();
    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8"><span class="loading loading-spinner loading-lg"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

    try {
        const response = await fetch('/sales/api/held-bills/'); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö urls.py
        const data = await response.json();

        if (data.success) {
            updateHeldBadge(data.bills.length);

            if (data.bills.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•</td></tr>';
                return;
            }

            let html = '';
            data.bills.forEach(bill => {
                html += `
                    <tr class="hover">
                        <td class="text-center font-mono text-xs">${bill.date} ‡∏ô.</td>
                        <td class="font-bold text-sm">${bill.doc_no}</td>
                        <td class="text-sm text-gray-600">${bill.remark}</td>
                        <td class="text-right font-bold text-primary">
                            ${bill.total.toLocaleString()} ‡∏ø
                            <div class="text-[10px] text-gray-400">(${bill.items_count} ‡∏ä‡∏¥‡πâ‡∏ô)</div>
                        </td>
                        <td class="text-center">
                            <div class="join">
                                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö -->
                                <button onclick="resumeBill(${bill.id})" class="btn btn-sm btn-success join-item text-white" title="‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠">
                                    ‚ñ∂Ô∏è
                                </button>
                                
                                <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡∏™‡∏µ‡πÅ‡∏î‡∏á) -->
                                <button onclick="discardBill(${bill.id})" class="btn btn-sm btn-error join-item text-white" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;

        } else {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-error">Error: ${data.error}</td></tr>`;
        }

    } catch (error) {
        console.error('Load held bills error:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-error">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î</td></tr>';
    }
}

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Badge)
function updateHeldBadge(count) {
    const badge = document.getElementById('held-count-badge');
    if (count > 0) {
        badge.textContent = count;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

// ===================================
// ‚úÖ 4. ‡∏î‡∏∂‡∏á‡∏ö‡∏¥‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏≥‡∏ï‡πà‡∏≠ (Resume)
// ===================================
async function resumeBill(saleId) {
    if (cart.length > 0) {
        if (!confirm('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
    }

    try {
        const response = await fetch(`/sales/api/resume/${saleId}/`);
        const data = await response.json();

        if (data.success) {
            // 1. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            currentSaleId = saleId;
            cart = [];
            
            // 2. ‡πÄ‡∏≠‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
            data.sale.items.forEach(item => {
                cart.push({
                    id: item.id,
                    sku: item.sku,
                    name: item.name,
                    compatible_models: item.compatible_models || '',
                    unit: item.unit,
                    price: item.price,
                    selling_price: item.selling_price,
                    wholesale_price: item.wholesale_price,
                    stock_units: item.stock_units,
                    quantity: item.quantity,
                    original_price: item.original_price
                });
            });

            // 3. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
            document.getElementById('discount-input').value = data.sale.discount;
            
            // ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÄ‡∏Å‡πà‡∏≤ (‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏ã‡πâ‡∏≥)
            // (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ docNo ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô let)
            const docNoElement = document.getElementById('doc-no');
            if(docNoElement) docNoElement.textContent = data.sale.doc_no;
            
            // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ docNo ‡πÄ‡∏õ‡πá‡∏ô const ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ 
            // *‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô const docNo = ... ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÄ‡∏õ‡πá‡∏ô var ‡∏´‡∏£‡∏∑‡∏≠ let docNo = ...
            // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ window.docNo ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            
            // 4. ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà
            renderCart();
            updateSummary();
            
            // 5. ‡∏õ‡∏¥‡∏î Modal
            document.getElementById('held_bills_modal').close();
            
        } else {
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: ' + data.error);
        }

    } catch (error) {
        console.error('Resume error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    }
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
setTimeout(loadHeldBills, 500);


// ===================================
// Event Listeners
// ===================================
document.addEventListener('DOMContentLoaded', function() {
  
  document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      searchProducts();
    }
  });
  
  document.getElementById('search-btn').addEventListener('click', searchProducts);
  document.getElementById('checkout-btn').addEventListener('click', openPaymentModal);
  document.getElementById('clear-cart-btn').addEventListener('click', clearCart);
  
  document.getElementById('price-type-select').addEventListener('change', function() {
    const newType = this.value;
    
    if (cart.length > 0) {
      if (confirm('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤?')) {
        currentPriceType = newType;
        
        cart.forEach(item => {
          const isCustomPrice = item.price !== item.original_price;
          
          if (!isCustomPrice) {
            const newPrice = newType === 'wholesale' ? item.wholesale_price : item.selling_price;
            item.price = newPrice;
            item.original_price = newPrice;
          }
        });
        
        renderCart();
      } else {
        this.value = currentPriceType;
      }
    } else {
      currentPriceType = newType;
    }
  });
  
  renderCart();
});

// ===================================
// ‚úÖ 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡∏û‡∏±‡∏Å (Discard)
// ===================================
async function discardBill(saleId) {
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏û‡∏±‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;

    try {
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏• (URL ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö urls.py)
        const response = await fetch(`/sales/api/discard/${saleId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();

        if (data.success) {
            // ‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -> ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            loadHeldBills();
        } else {
            alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + data.error);
        }
    } catch (error) {
        console.error('Discard error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
    }
}
</script>

</body>
</html>