{% load tailwind_tags %}
<!doctype html>
<html lang="th" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</title>
  {% tailwind_css %}
  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
  </style>
</head>
<body class="bg-base-200">
<div class="flex min-h-screen">

  {# ========== Sidebar ========== #}
  {% include "partials/sidebar.html" %}

  {# ========== Main ========== #}
  <main class="flex-1 p-8 overflow-y-auto">
    <div class="max-w-[1800px] mx-auto">
      
      {# Header #}
      <div class="mb-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üì¶ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</h1>
            <p class="text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</p>
          </div>
          <div class="stats shadow">
            <div class="stat">
              <div class="stat-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á</div>
              <div class="stat-value text-primary">{{ total_rows|default:0 }}</div>
            </div>
          </div>
        </div>
      </div>

      {# Messages #}
      {% if messages %}
        <div class="mb-6 space-y-2">
          {% for m in messages %}
            <div class="alert {% if m.tags == 'success' %}alert-success{% elif m.tags == 'error' %}alert-error{% elif m.tags == 'warning' %}alert-warning{% else %}alert-info{% endif %} shadow-lg">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                {% if m.tags == 'success' %}
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                {% else %}
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                {% endif %}
              </svg>
              <span>{{ m|safe }}</span>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="grid xl:grid-cols-12 gap-6">

        {# ========== ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ã‡πâ‡∏≤‡∏¢) ========== #}
        <div class="xl:col-span-5">
          <div class="card bg-base-100 shadow-xl sticky top-4">
            <div class="card-body">
              <h2 class="card-title text-xl mb-4">
                {% if edit_data %}
                  <span class="text-warning">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: {{ edit_data.sku }}</span>
                {% else %}
                  ‚úèÔ∏è ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                {% endif %}
              </h2>
              
              <form method="post" id="addForm" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_row">

                {# ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà #}
                <div class="form-control">
                  <label class="label"><span class="label-text font-semibold">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà <span class="text-error">*</span></span></label>
                  <select name="category" class="select select-bordered" required>
                    <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>
                    {% for c in categories %}
                      <option value="{{ c.id }}" {% if edit_data and edit_data.category_id == c.id %}selected{% endif %}>
                        {{ c.name }}
                      </option>
                    {% endfor %}
                  </select>
                </div>

                {# SKU & ‡∏ä‡∏∑‡πà‡∏≠ #}
                <div class="grid grid-cols-3 gap-2">
                  <div class="form-control col-span-1">
                    <label class="label"><span class="label-text font-semibold">SKU</span></label>
                    <input name="sku" class="input input-bordered" placeholder="Auto" value="{{ edit_data.sku|default:'' }}">
                  </div>
                  <div class="form-control col-span-2">
                    <label class="label"><span class="label-text font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <span class="text-error">*</span></span></label>
                    <input name="name" class="input input-bordered" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡πâ‡∏≤‡πÄ‡∏ö‡∏£‡∏Å Toyota" value="{{ edit_data.name|default:'' }}">
                  </div>
                </div>

                {# üöó ‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ #}
                <div class="bg-gradient-to-r from-orange-50 to-yellow-50 p-3 rounded-lg border border-orange-100">
                  <h3 class="font-bold text-sm mb-2 text-orange-800">üöó ‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</h3>
                  <div class="form-control">
                    <textarea name="compatible_models" class="textarea textarea-bordered h-20 bg-white" 
                              placeholder="‡πÄ‡∏ä‡πà‡∏ô Vios 2012, Yaris 2014, City 2010 (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)">{{ edit_data.compatible_models|default:'' }}</textarea>
                    <label class="label pb-0">
                      <span class="label-text-alt text-orange-600">üí° ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô</span>
                    </label>
                  </div>
                </div>

                {# üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤ #}
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-3 rounded-lg space-y-2 border border-blue-100">
                  <h3 class="font-bold text-sm text-blue-800">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤</h3>
                  <div class="grid grid-cols-2 gap-2">
                    <div class="form-control">
                      <label class="label py-1"><span class="label-text text-xs">‡∏ó‡∏∏‡∏ô</span></label>
                      <input type="number" name="cost_price" class="input input-bordered input-sm bg-white" 
                             step="0.01" value="{{ edit_data.cost_price|default:'' }}" placeholder="0.00">
                    </div>
                    <div class="form-control">
                      <label class="label py-1"><span class="label-text text-xs font-bold text-primary">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</span></label>
                      <input type="number" name="selling_price" class="input input-bordered input-sm font-bold text-primary bg-white" 
                             step="0.01" value="{{ edit_data.selling_price|default:'' }}" placeholder="0.00">
                    </div>
                    <div class="form-control col-span-2">
                      <label class="label py-1"><span class="label-text text-xs">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡πà‡∏á (‡∏≠‡∏π‡πà/‡∏ä‡πà‡∏≤‡∏á)</span></label>
                      <input type="number" name="wholesale_price" class="input input-bordered input-sm bg-white" 
                             step="0.01" value="{{ edit_data.wholesale_price|default:'' }}" placeholder="0.00">
                    </div>
                  </div>
                </div>

                {# üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô #}
                <div class="bg-gradient-to-r from-green-50 to-teal-50 p-3 rounded-lg space-y-2 border border-green-100">
                  <h3 class="font-bold text-sm text-green-800">üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</h3>
                  <div class="grid grid-cols-2 gap-2">
                    <div class="form-control">
                      <label class="label py-1"><span class="label-text text-xs">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</span></label>
                      <select name="unit" id="unitSelect" class="select select-bordered select-sm bg-white">
                        <option value="‡∏ä‡∏¥‡πâ‡∏ô" {% if edit_data.unit == "‡∏ä‡∏¥‡πâ‡∏ô" %}selected{% endif %}>‡∏ä‡∏¥‡πâ‡∏ô</option>
                        <option value="‡∏Å‡∏•‡πà‡∏≠‡∏á" {% if edit_data.unit == "‡∏Å‡∏•‡πà‡∏≠‡∏á" %}selected{% endif %}>‡∏Å‡∏•‡πà‡∏≠‡∏á</option>
                        <option value="‡∏ä‡∏∏‡∏î" {% if edit_data.unit == "‡∏ä‡∏∏‡∏î" %}selected{% endif %}>‡∏ä‡∏∏‡∏î</option>
                        <option value="‡∏Ñ‡∏π‡πà" {% if edit_data.unit == "‡∏Ñ‡∏π‡πà" %}selected{% endif %}>‡∏Ñ‡∏π‡πà</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-control">
                    <label class="label py-1"><span class="label-text text-sm font-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <span class="text-error">*</span></span></label>
                    <input type="number" name="quantity" id="qtyInput" class="input input-bordered input-lg font-bold text-success bg-white text-center" 
                           step="0.01" required value="{{ edit_data.quantity|default:'' }}" placeholder="0">
                  </div>
                  <div class="text-center text-xs text-green-700 font-bold bg-white/50 py-1 rounded">
                     = ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á <span id="actualQty" class="text-lg">0</span> ‡∏ä‡∏¥‡πâ‡∏ô
                  </div>
                </div>

                {# ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô Collapse) #}
                <div class="collapse collapse-arrow border border-base-200 bg-base-100 rounded-box">
                  <input type="checkbox" /> 
                  <div class="collapse-title text-sm font-medium">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Supplier/Ref)</div>
                  <div class="collapse-content space-y-2">
                    <input type="text" name="created_by" class="input input-bordered input-sm w-full" 
                           value="{{ edit_data.created_by|default:request.user.username }}" placeholder="‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤">
                    <input type="text" name="reference" class="input input-bordered input-sm w-full" 
                           value="{{ edit_data.reference|default:'' }}" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á">
                    <select name="supplier" class="select select-bordered select-sm w-full">
                      <option value="">-- ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå --</option>
                      {% for s in suppliers %}
                        <option value="{{ s.id }}">{{ s.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block btn-lg shadow-lg shadow-primary/30">
                  {% if edit_data %}üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç{% else %}‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á{% endif %}
                </button>
              </form>
            </div>
          </div>
        </div>

        {# ========== ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏Ç‡∏ß‡∏≤) ========== #}
        <div class="xl:col-span-7">
          <div class="card bg-base-100 shadow-xl h-full">
            <div class="card-body p-0">
              {# ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á #}
              <div class="flex justify-between items-center p-4 bg-gradient-to-r from-violet-500 to-purple-500 text-white rounded-t-xl">
                <h2 class="card-title text-xl">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>
                <div class="badge badge-lg bg-white/20 border-0 text-white">{{ total_rows|default:0 }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              </div>

              <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                  <thead>
                    <tr class="bg-base-200 text-base-content/70">
                      <th class="w-10 text-center">#</th>
                      <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                      <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                      <th class="w-1/4">‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ</th>
                      <th class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏Ç‡∏≤‡∏¢/‡∏™‡πà‡∏á/‡∏ó‡∏∏‡∏ô)</th>
                      <th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                      <th class="text-center w-20">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for r in stage %}
                    <tr class="hover">
                      <td class="text-center font-bold opacity-50">{{ forloop.counter }}</td>
                      <td>
                        {% if r.sku %}
                          <span class="badge badge-neutral badge-lg font-mono font-bold">{{ r.sku }}</span>
                        {% else %}
                          <span class="badge badge-ghost badge-lg font-mono text-slate-400">Auto</span>
                        {% endif %}
                      </td>
                      <td>
                        <div class="font-bold">{{ r.name }}</div>
                        <div class="text-[10px] text-primary mt-1">{{ r.category_name }}</div>
                      </td>
                      <td>
                        <div class="text-xs line-clamp-2" title="{{ r.compatible_models }}">
                          {{ r.compatible_models|default:"-" }}
                        </div>
                      </td>
                      <td class="text-right space-y-1">
                        <div class="font-bold text-primary">{{ r.selling_price }}</div>
                        <div class="text-xs opacity-60">{{ r.wholesale_price }} (‡∏™‡πà‡∏á)</div>
                        <div class="text-xs opacity-60">{{ r.cost_price }} (‡∏ó‡∏∏‡∏ô)</div>
                      </td>
                      <td class="text-right">
                        <span class="badge badge-success badge-lg font-bold text-white">
                          {{ r.quantity }} {{ r.unit }}
                        </span>
                        {% if r.pieces_per_unit != '1' %}
                          <div class="text-[10px] opacity-50 mt-1">x{{ r.pieces_per_unit }}</div>
                        {% endif %}
                      </td>
                      <td class="text-center">
                        <div class="join join-vertical">
                          <button onclick="editRow({{ forloop.counter0 }})" class="btn btn-xs btn-ghost text-warning join-item">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                          <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="remove_row">
                            <input type="hidden" name="index" value="{{ forloop.counter0 }}">
                            <button class="btn btn-xs btn-ghost text-error join-item">‡∏•‡∏ö</button>
                          </form>
                        </div>
                      </td>
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="7" class="text-center py-10 opacity-50">
                        <div class="text-5xl mb-2">üì≠</div>
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              <div class="p-4 bg-base-50 rounded-b-xl flex justify-end gap-3 border-t">
                <form method="post">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="clear_all">
                  <button type="submit" class="btn btn-ghost text-error" {% if not stage %}disabled{% endif %}>
                    ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                  </button>
                </form>
                <form method="post">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="commit">
                  <button type="submit" class="btn btn-success text-white px-8 shadow-lg shadow-success/30" {% if not stage %}disabled{% endif %}>
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const qtyInput = document.getElementById('qtyInput');
    const actualQtySpan = document.getElementById('actualQty');

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    function updateActualQty() {
      // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Input ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô 0
      const val = qtyInput.value ? qtyInput.value : 0;
      
      // ‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡∏ö‡πÅ‡∏ö‡∏ö 1:1 ‡πÄ‡∏•‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡πÜ ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
      actualQtySpan.innerText = val; 
    }

    // 1. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå (Real-time)
    qtyInput.addEventListener('input', updateActualQty);

    // 2. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
    updateActualQty();
  });
</script>
</body>
</html>